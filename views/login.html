<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Book a Meal</title>
		<style>
			body {
				font-family: sans-serif;
				display: flex;
				justify-content: center;
				align-items: center;
				min-height: 100vh;
				background-color: #f0f0f0;
				margin: 0;
				flex-direction: column;
			}
			.container {
				background-color: #fff;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				padding: 30px;
				text-align: center;
			}
			h1 {
				margin-top: 0;
				color: #333;
			}
			.form-group {
				margin-bottom: 15px;
				text-align: left;
			}
			.form-group label {
				display: block;
				margin-bottom: 5px;
				font-weight: bold;
				color: #555;
			}
			.form-group input {
				width: 100%;
				padding: 8px;
				border: 1px solid #ccc;
				border-radius: 4px;
				box-sizing: border-box;
			}
			.form-group input:disabled {
				background-color: #e9e9e9;
				cursor: not-allowed;
			}
			button {
				background-color: #007bff;
				color: white;
				padding: 10px 20px;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-size: 16px;
				transition: background-color 0.2s ease-in-out;
			}
			button:hover {
				background-color: #0056b3;
			}
			button:disabled {
				background-color: #cccccc;
				cursor: not-allowed;
			}

			#result {
				margin-top: 20px;
				padding: 20px;
				background-color: #e9e9e9;
				border-radius: 8px;
				text-align: left;
				display: none;
			}
			#qrCodeImage {
				margin-top: 15px;
				max-width: 150px;
				height: auto;
				display: block;
				margin-left: auto;
				margin-right: auto;
			}
			.error {
				color: red;
				margin-top: 10px;
			}
			.orange-alert {
				color: #cc5500;
				background-color: #fff3cd;
				border: 1px solid #ffecb5;
				padding: 10px;
				border-radius: 4px;
				margin-top: 15px;
				display: none;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>Book Your Meal</h1>
			<form id="bookMealForm">
				<div class="form-group" id="emailFormGroup">
					<label for="employeeEmail">Employee Email:</label>
					<input type="email" id="employeeEmail" required />
				</div>

				<div class="form-group" id="employeeIdFormGroup">
					<label for="employeeId">Employee ID:</label>
					<input type="text" id="employeeId" required />
				</div>

				<div class="form-group" id="nameFormGroup" style="display: none">
					<label for="employeeName">Your Name:</label>
					<input type="text" id="employeeName" required />
				</div>

				<div class="form-group" id="otpFormGroup">
					<label for="otpCode">Enter OTP:</label>
					<input type="text" id="otpCode" required disabled />
				</div>

				<button type="submit" id="actionButton">Send OTP</button>

				<div class="error" id="errorMessage"></div>

				<p class="orange-alert" id="firstTimeAlert">
					It seems you're new! Please provide your name to sign up for your
					first meal.
				</p>
			</form>
		</div>

		<script>
			document.addEventListener("DOMContentLoaded", function () {
				const form = document.getElementById("bookMealForm");
				const emailFormGroup = document.getElementById("emailFormGroup");
				const employeeEmailInput = document.getElementById("employeeEmail");
				const employeeIdFormGroup = document.getElementById(
					"employeeIdFormGroup",
				);
				const employeeIdInput = document.getElementById("employeeId");
				const nameFormGroup = document.getElementById("nameFormGroup");
				const employeeNameInput = document.getElementById("employeeName");
				const otpFormGroup = document.getElementById("otpFormGroup");
				const otpInput = document.getElementById("otpCode");
				const actionButton = document.getElementById("actionButton");
				const errorMessageDiv = document.getElementById("errorMessage");
				const firstTimeAlert = document.getElementById("firstTimeAlert");

				function updateFormState(state) {
					errorMessageDiv.textContent = "";
					firstTimeAlert.style.display = "none";

					switch (state) {
						case "initial":
							emailFormGroup.style.display = "";
							employeeIdFormGroup.style.display = "";
							employeeEmailInput.disabled = false;
							employeeIdInput.disabled = false;

							nameFormGroup.style.display = "none";
							employeeNameInput.required = false;
							employeeNameInput.value = "";

							otpFormGroup.style.display = "";
							otpInput.disabled = true;
							otpInput.value = "";

							actionButton.textContent = "Send OTP";
							actionButton.disabled = false;
							break;

						case "processing":
							employeeEmailInput.disabled = true;
							employeeIdInput.disabled = true;
							employeeNameInput.disabled = true;
							otpInput.disabled = true;
							actionButton.disabled = true;
							break;

						case "signup":
							emailFormGroup.style.display = "";
							employeeIdFormGroup.style.display = "";
							employeeEmailInput.disabled = true;
							employeeIdInput.disabled = true;

							nameFormGroup.style.display = "";
							employeeNameInput.required = true;
							employeeNameInput.disabled = false;

							otpFormGroup.style.display = "";
							otpInput.disabled = true;
							otpInput.value = "";

							actionButton.textContent = "Sign Up and Send OTP";
							actionButton.disabled = false;

							firstTimeAlert.style.display = "block";
							break;

						case "verify":
							emailFormGroup.style.display = "";
							employeeIdFormGroup.style.display = "";
							employeeEmailInput.disabled = true;
							employeeIdInput.disabled = true;

							nameFormGroup.style.display = "none";
							employeeNameInput.required = false;
							employeeNameInput.disabled = true;

							otpFormGroup.style.display = "";
							otpInput.disabled = false;
							otpInput.focus();

							actionButton.textContent = "Verify OTP";
							actionButton.disabled = false;
							break;

						case "otp_verified":
							form.style.display = "none";
							errorMessageDiv.textContent =
								"OTP Verified. Please proceed to scan the vendor QR code.";
							errorMessageDiv.style.color = "green";
							errorMessageDiv.style.display = "block";
							break;

						default:
							console.error("Unknown form state:", state);
							updateFormState("initial");
					}
				}

				function handleError(message, newState = "initial") {
					errorMessageDiv.textContent = message;
					updateFormState(newState);
				}

				updateFormState("initial");

				form.addEventListener("submit", async function (event) {
					event.preventDefault();

					const email = employeeEmailInput.value.trim();
					const eid = employeeIdInput.value.trim();
					const name = employeeNameInput.value.trim();
					const otp = otpInput.value.trim();

					const requiredDomain = "@nielsen.com";

					errorMessageDiv.textContent = "";
					firstTimeAlert.style.display = "none";

					if (actionButton.textContent === "Send OTP") {
						// Stage 1: Validate email, check user, and send OTP

						if (!email.endsWith(requiredDomain)) {
							handleError("Email must end with " + requiredDomain, "initial");
							return;
						}

						if (!eid) {
							handleError("Please enter your Employee ID.", "initial");
							return;
						}

						console.log("Email and Employee ID valid. Checking user...");
						updateFormState("processing");

						try {
							const response = await fetch(
								`/user?email=${encodeURIComponent(
									email,
								)}&employeeId=${encodeURIComponent(eid)}`,
								{
									method: "GET",
								},
							);

							if (!response.ok) {
								const errorData = await response.json();
								handleError(
									errorData.message || "Error checking user existence.",
									"initial",
								);
								console.error(
									"Backend user check error:",
									response.status,
									errorData,
								);
								return;
							}

							const data = await response.json();

							if (data.exists) {
								console.log("User found. Triggering OTP send...");

								try {
									const otpSendResponse = await fetch("/send-otp", {
										method: "POST",
										headers: {
											"Content-Type": "application/json",
										},
										body: JSON.stringify({ email: email, employeeId: eid }),
									});

									if (!otpSendResponse.ok) {
										const errorData = await otpSendResponse.json();
										handleError(
											errorData.message || "Error sending OTP.",
											"initial",
										);
										console.error(
											"Backend OTP send error:",
											otpSendResponse.status,
											errorData,
										);
										return;
									}

									const otpSendData = await otpSendResponse.json();

									if (otpSendData.success) {
										console.log("OTP sent successfully!");
										updateFormState("verify");
									} else {
										handleError(
											otpSendData.message ||
												"Failed to send OTP. Please try again.",
											"initial",
										);
									}
								} catch (error) {
									console.error("Error sending OTP request:", error);
									handleError(
										"Network error during OTP send. Please try again.",
										"initial",
									);
								}
							} else {
								console.log("User not found. Prompting for name...");
								updateFormState("signup");
							}
						} catch (error) {
							console.error("Error checking user existence:", error);
							handleError(
								"Network error during user check. Please try again.",
								"initial",
							);
						}
					} else if (actionButton.textContent === "Sign Up and Send OTP") {
						// Stage 2a: Handle Sign Up and Send OTP for a new user

						const name = employeeNameInput.value.trim();
						const email = employeeEmailInput.value.trim();
						const eid = employeeIdInput.value.trim();

						if (!name) {
							handleError("Please enter your name.", "signup");
							return;
						}

						console.log("New user signing up...");
						updateFormState("processing");

						// --- Fetch to sign up user ---
						try {
							const signUpResponse = await fetch("/signup", {
								method: "POST",
								headers: {
									"Content-Type": "application/json",
								},
								body: JSON.stringify({
									email: email,
									employeeId: eid,
									name: name,
								}),
							});

							if (!signUpResponse.ok) {
								const errorData = await signUpResponse.json();
								handleError(
									errorData.message || "Error during sign up.",
									"signup",
								);
								console.error(
									"Backend sign up error:",
									signUpResponse.status,
									errorData,
								);
								return;
							}

							const signUpData = await signUpResponse.json();

							if (signUpData.success) {
								console.log("Sign up successful! Now sending OTP...");

								// --- Fetch to send OTP after successful signup ---
								try {
									const otpSendResponse = await fetch("/send-otp", {
										method: "POST",
										headers: {
											"Content-Type": "application/json",
										},
										body: JSON.stringify({ email: email, employeeId: eid }),
									});

									if (!otpSendResponse.ok) {
										const errorData = await otpSendResponse.json();
										handleError(
											errorData.message || "Error sending OTP after signup.",
											"signup",
										);
										console.error(
											"Backend OTP send error after signup:",
											otpSendResponse.status,
											errorData,
										);
										return;
									}

									const otpSendData = await otpSendResponse.json();

									if (otpSendData.success) {
										console.log("OTP sent successfully after signup!");
										updateFormState("verify");
									} else {
										handleError(
											otpSendData.message || "Failed to send OTP after signup.",
											"signup",
										);
									}
								} catch (error) {
									console.error(
										"Error sending OTP request after signup:",
										error,
									);
									handleError(
										"Network error during OTP send after signup. Please try again.",
										"signup",
									);
								}
							} else {
								handleError(
									signUpData.message || "Failed to sign up.",
									"signup",
								);
							}
						} catch (error) {
							console.error("Error during sign up request:", error);
							handleError(
								"Network error during sign up. Please try again.",
								"signup",
							);
						}
					} else if (actionButton.textContent === "Verify OTP") {
						// Stage 2b (or Stage 3): Verify OTP
						const otp = otpInput.value.trim();
						const email = employeeEmailInput.value.trim();
						const empId = employeeIdInput.value.trim();

						if (!otp) {
							handleError("Please enter the OTP.", "verify");
							return;
						}

						console.log("Verifying OTP:", otp);
						updateFormState("processing");

						try {
							const verifyResponse = await fetch("/verify-otp", {
								method: "POST",
								headers: {
									"Content-Type": "application/json",
								},
								body: JSON.stringify({
									email: email,
									empId: empId,
									otp: otp,
								}),
							});

							if (!verifyResponse.ok) {
								const errorData = await verifyResponse.json();
								handleError(
									errorData.message || "Error verifying OTP.",
									"verify",
								);
								console.error(
									"Backend OTP verify error:",
									verifyResponse.status,
									errorData,
								);
								return;
							}

							const verifyData = await verifyResponse.json();

							if (verifyData.success) {
								console.log("OTP Verified. Ready for Vendor QR Scan.");
								updateFormState("otp_verified");
							} else {
								handleError(
									verifyData.message || "Invalid OTP. Please try again.",
									"verify",
								);
							}
						} catch (error) {
							console.error("Error verifying OTP request:", error);
							handleError("Network error during OTP verification.", "verify");
						}
					}
				});

				employeeEmailInput.addEventListener("input", resetFormState);
				employeeIdInput.addEventListener("input", resetFormState);
				employeeNameInput.addEventListener("input", resetFormState);

				function resetFormState() {
					updateFormState("initial");
				}
			});
		</script>
	</body>
</html>
