<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Redeem Your Meal</title>
		<style>
			body {
				font-family: sans-serif;
				display: flex;
				justify-content: center;
				align-items: center;
				min-height: 100vh;
				background-color: #f0f0f0;
				margin: 0;
				flex-direction: column;
				padding: 20px;
			}
			.container {
				background-color: #fff;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				padding: 30px;
				text-align: center;
				max-width: 500px;
				width: 100%;
			}
			h1,
			h2 {
				color: #333;
			}
			.user-info {
				margin-bottom: 20px;
				text-align: left;
				padding: 15px;
				border: 1px solid #ccc;
				border-radius: 4px;
				background-color: #f9f9f9;
			}
			.user-info p {
				margin: 5px 0;
			}
			.instruction {
				margin-top: 20px;
				font-size: 1.1em;
				color: #555;
			}
			button {
				background-color: #007bff;
				color: white;
				padding: 10px 20px;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-size: 16px;
				transition: background-color 0.2s ease-in-out;
				margin-top: 20px;
			}
			button:hover {
				background-color: #0056b3;
			}
			#reader {
				width: 100%;
				margin-top: 20px;
				border: 1px solid #ccc;
				border-radius: 4px;
			}
			#reader video {
				width: 100% !important;
				height: auto !important;
				display: block;
			}

			.result-message {
				margin-top: 20px;
				padding: 15px;
				border-radius: 4px;
			}
			.result-success {
				background-color: #d4edda;
				color: #155724;
				border-color: #c3e6cb;
			}
			.result-error {
				background-color: #f8d7da;
				color: #721c24;
				border-color: #f5c6cb;
			}

			.confirmation-section {
				margin-top: 20px;
				padding: 20px;
				border-radius: 8px;
				background-color: #e9e9e9;
				text-align: center;
			}
			.green-tick {
				font-size: 4em;
				color: green;
				margin-bottom: 10px;
				display: block;
			}
			.booking-details p {
				margin: 8px 0;
				font-size: 1.1em;
			}
			.confirmation-statement {
				margin-top: 15px;
				font-size: 1.2em;
				font-weight: bold;
				color: #155724;
			}
		</style>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
	</head>
	<body>
		<div class="container">
			<h1>Meal Redemption</h1>

			<div class="user-info" id="userInfoSection">
				<h2>Your Information:</h2>
				<p><strong>Name:</strong> <span id="userName">{{ user.name }}</span></p>
				<p>
					<strong>Email:</strong> <span id="userEmail">{{ user.email }}</span>
				</p>
				<p>
					<strong>Employee ID:</strong>
					<span id="userEmpId">{{ user.employeeId }}</span>
				</p>
			</div>

			<div id="scanningInterface">
				<p class="instruction">
					Please scan the vendor's QR code below to redeem your meal.
				</p>

				<button id="startScanButton">Scan QR Code</button>

				<div id="reader" style="display: none"></div>

				<div
					id="scanResultMessage"
					class="result-message"
					style="display: none"
				></div>
			</div>

			<div
				id="redemptionConfirmation"
				class="confirmation-section"
				style="display: none"
			>
				<span class="green-tick">âœ“</span>
				<h2>Redemption Successful!</h2>

				<div class="booking-details">
					<p>
						<strong>Redemption ID:</strong>
						<span id="confirmationBookingId"></span>
					</p>
					<p><strong>Date:</strong> <span id="confirmationDate"></span></p>
				</div>

				<p class="confirmation-statement">
					You have redeemed your meal for today (<span
						id="redeemedDateStatement"
					></span
					>).
				</p>
			</div>
		</div>

		<script>
			document.addEventListener("DOMContentLoaded", function () {
				const startScanButton = document.getElementById("startScanButton");
				const qrCodeReaderElement = document.getElementById("reader");
				const scanResultMessage = document.getElementById("scanResultMessage");
				const scanningInterface = document.getElementById("scanningInterface");

				const redemptionConfirmation = document.getElementById(
					"redemptionConfirmation",
				);
				const confirmationBookingId = document.getElementById(
					"confirmationBookingId",
				);
				const confirmationDateSpan =
					document.getElementById("confirmationDate");
				const redeemedDateStatementSpan = document.getElementById(
					"redeemedDateStatement",
				);

				const currentUser = {
					name: document.getElementById("userName").textContent,
					email: document.getElementById("userEmail").textContent,
					employeeId: document.getElementById("userEmpId").textContent,
				};

				let html5QrcodeScanner = null;

				scanningInterface.style.display = "block";
				redemptionConfirmation.style.display = "none";

				startScanButton.addEventListener("click", function () {
					startScanButton.style.display = "none";
					qrCodeReaderElement.style.display = "block";
					scanResultMessage.style.display = "none";

					if (!html5QrcodeScanner) {
						html5QrcodeScanner = new Html5Qrcode("reader");
					}

					html5QrcodeScanner
						.start(
							{ facingMode: "environment" },
							{
								fps: 10,
								qrbox: { width: 250, height: 250 },
							},
							onScanSuccess,
							onScanFailure,
						)
						.catch((err) => {
							console.error(`Unable to start scanning: ${err}`);
							scanResultMessage.textContent = `Error starting camera: ${err}`;
							scanResultMessage.className = "result-message result-error";
							scanResultMessage.style.display = "block";
							startScanButton.style.display = "block";
							qrCodeReaderElement.style.display = "none";
						});
				});

				async function onScanSuccess(decodedText, decodedResult) {
					console.log(`QR Code scanned: ${decodedText}`, decodedResult);

					if (html5QrcodeScanner) {
						html5QrcodeScanner
							.stop()
							.then(() => {
								console.log("QR scanning stopped.");
								qrCodeReaderElement.style.display = "none";
							})
							.catch((err) => {
								console.error("Error stopping scanner:", err);
								qrCodeReaderElement.style.display = "none";
							});
					}

					scanResultMessage.style.display = "block";
					scanResultMessage.textContent = "Processing redemption...";
					scanResultMessage.className = "result-message";

					console.log("Sending scanned data to backend for redemption...");

					try {
						const redeemResponse = await fetch("/booking/meal", {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
							},
							body: JSON.stringify({
								user: {
									email: currentUser.email,
									employeeId: currentUser.employeeId,
								},
								qrData: decodedText,
							}),
						});

						const redeemData = await redeemResponse.json();

						if (redeemResponse.ok) {
							if (redeemData.success) {
								console.log("Meal redemption successful:", redeemData);

								scanningInterface.style.display = "none";
								redemptionConfirmation.style.display = "block";

								confirmationBookingId.textContent =
									redeemData.bookingId || "N/A";

								const today = new Date();
								const options = {
									year: "numeric",
									month: "long",
									day: "numeric",
								};
								const formattedDate = today.toLocaleDateString(
									undefined,
									options,
								);

								confirmationDateSpan.textContent = formattedDate;
								redeemedDateStatementSpan.textContent = formattedDate;

								scanResultMessage.style.display = "none";
							} else {
								scanResultMessage.textContent =
									redeemData.message || "Meal redemption failed.";
								scanResultMessage.className = "result-message result-error";
								console.error("Meal redemption failed (backend):", redeemData);
							}
						} else {
							scanResultMessage.textContent =
								redeemData.message ||
								`Error during redemption: ${redeemResponse.status}`;
							scanResultMessage.className = "result-message result-error";
							console.error(
								"Meal redemption failed (HTTP error):",
								redeemResponse.status,
								redeemData,
							);
						}
					} catch (error) {
						console.error("Error sending redemption request:", error);
						scanResultMessage.textContent =
							"Network error during redemption. Please try again.";
						scanResultMessage.className = "result-message result-error";
					}
				}

				function onScanFailure(error) {}
			});
		</script>
	</body>
</html>
